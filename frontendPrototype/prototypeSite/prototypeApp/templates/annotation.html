{% extends 'base.html' %}

{% block content %}
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 800px; /* Adjust the maximum width as needed */
            margin: 0 auto;
            overflow: hidden;
        }

        #canvas {
            display: block;
            background: url("{{ picture.image.url }}") no-repeat;
            background-size: cover;
        }

        .circle {
            position: absolute;
            width: 10px; /* Adjust the size of the dot as needed */
            height: 10px;
            border-radius: 50%;
        }

        .buttons-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .buttons-container button {
            margin: 5px 5px;
        }

    /* hier kann man die hover animation von den buttons Ã¤ndern */
    #submit:hover, #showPixelButton:hover, #printBottomRightButton:hover, #clearButton:hover{
        background-color: brown;
    }
    #submit, #showPixelButton, #printBottomRightButton, #clearButton{
      display: inline-block;
      padding: 0.8rem 2rem;
      margin: 0.5rem;
      border: none;
      background-color: #4CAF50;
      color: white;
      font-size: 1rem;
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      border-radius: 0.25rem;
    }

    #userTextInput {
        width: 100%;
        height: 20px;
        margin-top: 20px;
        padding: 10px;
        font-size: 16px;
    }
    </style>


    <div class="container">
        <h1>Annotate Image</h1>

        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
        <!-- When you click the submit button a python file gets triggered and then inference is run on the submitted picture -->
        <!-- change path to the local one in you file system -->
        <form action="C:/Users/lucaa/Desktop/Master Studium/SS23/Praktikum Machine Learning in Graphics, Vision and Language (MSc) - SoSe 23/MedicalImageSegmentation WebDev/run_bash.py" id="annotation-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="dotPositions" id="dotPositionsInput">
            <textarea name="userText" id="userTextInput" placeholder="Enter your text"></textarea>
            <button type="submit">Submit</button>
        </form>

        <div class="buttons-container">
            <button id="showPixelButton">Show Pixel Location</button>
            <button id="printBottomRightButton">Print Bottom Right Corner</button>
            <button id="clearButton">Clear Dot</button>
            <input id="colorPicker" type="color">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.querySelector('#canvas');
            const ctx = canvas.getContext('2d');

            const image = new Image();
            image.src = "{{ picture.image.url }}";
            image.addEventListener('load', () => {
                const aspectRatio = image.width / image.height;
                const maxWidth = 800; // Maximum width for the canvas (adjust as needed)
                const maxHeight = maxWidth / aspectRatio;

                canvas.width = maxWidth;
                canvas.height = maxHeight;

                ctx.drawImage(image, 0, 0, maxWidth, maxHeight);
            });

            const dotSize = 10; // Adjust the size of the dot as needed
            let dotPositions = []; // Array to store dot positions
            let dotColor = '#d50909'; // Default dot color (red)

            const handleMouseDown = (event) => {
                const canvasRect = canvas.getBoundingClientRect();
                const offsetX = event.clientX - canvasRect.left;
                const offsetY = event.clientY - canvasRect.top;

                // Store the dot position in the array
                dotPositions.push({ x: offsetX, y: offsetY });

                const circle = document.createElement('div');
                circle.classList.add('circle');
                circle.style.left = `${offsetX - dotSize / 2}px`;
                circle.style.top = `${offsetY - dotSize / 2}px`;
                circle.style.backgroundColor = dotColor;
                document.querySelector('.canvas-container').appendChild(circle);

                canvas.removeEventListener('mousedown', handleMouseDown); // Remove the event listener
                // Update the dot positions input value
                document.querySelector('#dotPositionsInput').value = JSON.stringify(dotPositions);
            };

            canvas.addEventListener('mousedown', handleMouseDown);

            const showPixelButton = document.querySelector('#showPixelButton');
            showPixelButton.addEventListener('click', () => {
                const dot = dotPositions[dotPositions.length - 1];
                const x = Math.round(dot.x);
                const y = Math.round(dot.y);
                alert(`Clicked Location: (${x}px, ${y}px)`);
            });

            const printBottomRightButton = document.querySelector('#printBottomRightButton');
            printBottomRightButton.addEventListener('click', () => {
                const x = canvas.width;
                const y = canvas.height;
                alert(`Bottom Right Corner: (${x}px, ${y}px)`);
            });

            const colorPicker = document.querySelector('#colorPicker');
            colorPicker.addEventListener('change', (event) => {
                dotColor = event.target.value;
            });

            const clearButton = document.querySelector('#clearButton');
            clearButton.addEventListener('click', () => {
                // Clear dot positions array
                dotPositions = [];

                // Remove existing dot elements from the page
                const dots = document.querySelectorAll('.circle');
                dots.forEach((dot) => dot.remove());

                // Reattach the mouse click listener
                canvas.addEventListener('mousedown', handleMouseDown);
            });
        });
    </script>

{% endblock %}
